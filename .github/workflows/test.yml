name: Tests

on:
  push:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-tidy
        run: sudo apt-get update && sudo apt-get install -y clang-tidy

      - name: Run clang-tidy
        run: |
          clang-tidy src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c -- -DBOARD_SIZE=3 -std=c11 -I.
          clang-tidy src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c -- -DBOARD_SIZE=4 -std=c11 -I.

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build
        run: make CC=${{ matrix.compiler }} BOARD_SIZE=${{ matrix.board_size }}

      - name: Run tests
        run: make test CC=${{ matrix.compiler }} BOARD_SIZE=${{ matrix.board_size }}

      - name: Self-play verification
        run: |
          echo "Running self-play verification for perfect play..."
          OUTPUT=$(./ttt -s 1000000)
          echo "$OUTPUT"

          # Extract win/tie counts from output
          X_WINS=$(echo "$OUTPUT" | grep "X wins:" | awk '{print $3}')
          O_WINS=$(echo "$OUTPUT" | grep "O wins:" | awk '{print $3}')
          TIES=$(echo "$OUTPUT" | grep "Ties:" | awk '{print $2}')

          echo ""
          echo "=== Perfect Play Verification ==="
          echo "X wins: $X_WINS (expected: 0)"
          echo "O wins: $O_WINS (expected: 0)"
          echo "Ties: $TIES (expected: 1000000)"

          # Verify perfect play (all ties, no wins)
          if [ "$X_WINS" != "0" ]; then
            echo "FAILED: X should never win with perfect play (got $X_WINS wins)"
            exit 1
          fi

          if [ "$O_WINS" != "0" ]; then
            echo "FAILED: O should never win with perfect play (got $O_WINS wins)"
            exit 1
          fi

          if [ "$TIES" != "1000000" ]; then
            echo "FAILED: All games should be ties with perfect play (got $TIES ties)"
            exit 1
          fi

          echo "PASSED: Perfect play verified (100% ties)"

      - name: Self-play verification (TT disabled, 3x3 only)
        if: matrix.board_size == 3
        run: |
          echo "Running self-play verification with TT disabled..."
          OUTPUT=$(./ttt --tt-size 0 -s 100000)
          echo "$OUTPUT"

          # Extract win/tie counts from output
          X_WINS=$(echo "$OUTPUT" | grep "X wins:" | awk '{print $3}')
          O_WINS=$(echo "$OUTPUT" | grep "O wins:" | awk '{print $3}')
          TIES=$(echo "$OUTPUT" | grep "Ties:" | awk '{print $2}')

          echo ""
          echo "=== TT Disabled Verification ==="
          echo "X wins: $X_WINS (expected: 0)"
          echo "O wins: $O_WINS (expected: 0)"
          echo "Ties: $TIES (expected: 100000)"

          # Verify perfect play without TT (all ties, no wins)
          if [ "$X_WINS" != "0" ]; then
            echo "FAILED: X should never win with perfect play (got $X_WINS wins)"
            exit 1
          fi

          if [ "$O_WINS" != "0" ]; then
            echo "FAILED: O should never win with perfect play (got $O_WINS wins)"
            exit 1
          fi

          if [ "$TIES" != "100000" ]; then
            echo "FAILED: All games should be ties with perfect play (got $TIES ties)"
            exit 1
          fi

          echo "PASSED: Perfect play verified without TT (100% ties)"

  test-cmake:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        board_size: [3, 4]
        native_opt: [ON, OFF]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -B build -DBOARD_SIZE=${{ matrix.board_size }} -DCMAKE_BUILD_TYPE=Release -DENABLE_NATIVE_OPTIMIZATIONS=${{ matrix.native_opt }}

      - name: Build
        run: cmake --build build --config Release

      - name: Run tests
        run: ctest --test-dir build --build-config Release --output-on-failure

      - name: Self-play verification
        run: |
          echo "Running self-play verification for perfect play..."
          OUTPUT=$(./build/ttt -s 1000000)
          echo "$OUTPUT"

          # Extract win/tie counts from output
          X_WINS=$(echo "$OUTPUT" | grep "X wins:" | awk '{print $3}')
          O_WINS=$(echo "$OUTPUT" | grep "O wins:" | awk '{print $3}')
          TIES=$(echo "$OUTPUT" | grep "Ties:" | awk '{print $2}')

          echo ""
          echo "=== Perfect Play Verification ==="
          echo "X wins: $X_WINS (expected: 0)"
          echo "O wins: $O_WINS (expected: 0)"
          echo "Ties: $TIES (expected: 1000000)"

          # Verify perfect play (all ties, no wins)
          if [ "$X_WINS" != "0" ]; then
            echo "FAILED: X should never win with perfect play (got $X_WINS wins)"
            exit 1
          fi

          if [ "$O_WINS" != "0" ]; then
            echo "FAILED: O should never win with perfect play (got $O_WINS wins)"
            exit 1
          fi

          if [ "$TIES" != "1000000" ]; then
            echo "FAILED: All games should be ties with perfect play (got $TIES ties)"
            exit 1
          fi

          echo "PASSED: Perfect play verified (100% ties)"

      - name: Self-play verification (TT disabled, 3x3 only)
        if: matrix.board_size == 3
        run: |
          echo "Running self-play verification with TT disabled..."
          OUTPUT=$(./build/ttt --tt-size 0 -s 100000)
          echo "$OUTPUT"

          # Extract win/tie counts from output
          X_WINS=$(echo "$OUTPUT" | grep "X wins:" | awk '{print $3}')
          O_WINS=$(echo "$OUTPUT" | grep "O wins:" | awk '{print $3}')
          TIES=$(echo "$OUTPUT" | grep "Ties:" | awk '{print $2}')

          echo ""
          echo "=== TT Disabled Verification ==="
          echo "X wins: $X_WINS (expected: 0)"
          echo "O wins: $O_WINS (expected: 0)"
          echo "Ties: $TIES (expected: 100000)"

          # Verify perfect play without TT (all ties, no wins)
          if [ "$X_WINS" != "0" ]; then
            echo "FAILED: X should never win with perfect play (got $X_WINS wins)"
            exit 1
          fi

          if [ "$O_WINS" != "0" ]; then
            echo "FAILED: O should never win with perfect play (got $O_WINS wins)"
            exit 1
          fi

          if [ "$TIES" != "100000" ]; then
            echo "FAILED: All games should be ties with perfect play (got $TIES ties)"
            exit 1
          fi

          echo "PASSED: Perfect play verified without TT (100% ties)"

  test-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -B build -DBOARD_SIZE=${{ matrix.board_size }} -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Run tests
        run: ctest --test-dir build --build-config Release --output-on-failure

      - name: Self-play verification
        shell: pwsh
        run: |
          $output = & ./build/Release/ttt.exe -s 1000000
          $output | ForEach-Object { Write-Host $_ }

          $xWins = ($output | Select-String "X wins:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          $oWins = ($output | Select-String "O wins:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          $ties = ($output | Select-String "Ties:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })

          Write-Host ""
          Write-Host "=== Perfect Play Verification ==="
          Write-Host "X wins: $xWins (expected: 0)"
          Write-Host "O wins: $oWins (expected: 0)"
          Write-Host "Ties: $ties (expected: 1000000)"

          if ($xWins -ne "0") { Write-Host "FAILED: X wins"; exit 1 }
          if ($oWins -ne "0") { Write-Host "FAILED: O wins"; exit 1 }
          if ($ties -ne "1000000") { Write-Host "FAILED: Not all ties"; exit 1 }

          Write-Host "PASSED: Perfect play verified (100% ties)"

      - name: Self-play verification (TT disabled, 3x3 only)
        if: matrix.board_size == 3
        shell: pwsh
        run: |
          Write-Host "Running self-play verification with TT disabled..."
          $output = & ./build/Release/ttt.exe --tt-size 0 -s 100000
          $output | ForEach-Object { Write-Host $_ }

          $xWins = ($output | Select-String "X wins:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          $oWins = ($output | Select-String "O wins:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          $ties = ($output | Select-String "Ties:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })

          Write-Host ""
          Write-Host "=== TT Disabled Verification ==="
          Write-Host "X wins: $xWins (expected: 0)"
          Write-Host "O wins: $oWins (expected: 0)"
          Write-Host "Ties: $ties (expected: 100000)"

          if ($xWins -ne "0") { Write-Host "FAILED: X wins"; exit 1 }
          if ($oWins -ne "0") { Write-Host "FAILED: O wins"; exit 1 }
          if ($ties -ne "100000") { Write-Host "FAILED: Not all ties"; exit 1 }

          Write-Host "PASSED: Perfect play verified without TT (100% ties)"

  strict-warnings:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build with strict warnings
        run: |
          STRICT="-Wall -Wextra -Wpedantic -Werror"
          STRICT="$STRICT -Wshadow -Wconversion -Wsign-conversion -Wformat=2 -Wundef"
          STRICT="$STRICT -Wdouble-promotion -Wcast-qual -Wnull-dereference"
          STRICT="$STRICT -Wstrict-prototypes -Wmissing-prototypes"
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            STRICT="$STRICT -Wlogical-op -Wduplicated-cond -Wduplicated-branches"
          fi
          ${{ matrix.compiler }} -std=c11 $STRICT -DBOARD_SIZE=${{ matrix.board_size }} \
            src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o /dev/null -lm

  sanitize:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and run tests under ASan+UBSan
        run: |
          ${{ matrix.compiler }} -std=c11 -Wall -Wextra -Werror -g -fno-omit-frame-pointer \
            -fsanitize=address,undefined,float-divide-by-zero,float-cast-overflow,pointer-compare,pointer-subtract \
            -DBOARD_SIZE=${{ matrix.board_size }} -I test/unity \
            test/test_runner.c test/test_bitboard.c test/test_minimax.c test/test_zobrist.c \
            test/test_transposition_table.c test/test_game_scenarios.c test/test_edge_cases.c \
            test/test_correctness.c test/unity/unity.c \
            src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o test_runner_san -lm
          ./test_runner_san

      - name: Run self-play under ASan+UBSan (3x3 only)
        if: matrix.board_size == 3
        run: |
          ${{ matrix.compiler }} -std=c11 -Wall -Wextra -Werror -g -fno-omit-frame-pointer \
            -fsanitize=address,undefined,float-divide-by-zero,float-cast-overflow,pointer-compare,pointer-subtract \
            -DBOARD_SIZE=3 \
            src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o ttt_san -lm
          ./ttt_san -s 1000 -q

  msan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and run tests under MSan
        run: |
          clang -std=c11 -Wall -Wextra -Werror -g -fno-omit-frame-pointer \
            -fsanitize=memory -fsanitize-memory-track-origins=2 \
            -DBOARD_SIZE=${{ matrix.board_size }} -I test/unity \
            test/test_runner.c test/test_bitboard.c test/test_minimax.c test/test_zobrist.c \
            test/test_transposition_table.c test/test_game_scenarios.c test/test_edge_cases.c \
            test/test_correctness.c test/unity/unity.c \
            src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o test_runner_msan -lm
          ./test_runner_msan

      - name: Run self-play under MSan (3x3 only)
        if: matrix.board_size == 3
        run: |
          clang -std=c11 -Wall -Wextra -Werror -g -fno-omit-frame-pointer \
            -fsanitize=memory -fsanitize-memory-track-origins=2 \
            -DBOARD_SIZE=3 \
            src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o ttt_msan -lm
          ./ttt_msan -s 1000 -q
