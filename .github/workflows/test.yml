name: Tests

on:
  push:
  pull_request:

permissions:
  contents: read

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install static analysis tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y clang-tidy cppcheck

      - name: Configure CMake for clang-tidy (BOARD_SIZE=3)
        run: |
          set -euo pipefail
          cmake -B build/tidy-3 -DBOARD_SIZE=3 -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Configure CMake for clang-tidy (BOARD_SIZE=4)
        run: |
          set -euo pipefail
          cmake -B build/tidy-4 -DBOARD_SIZE=4 -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy (warnings as errors)
        run: |
          set -euo pipefail
          SRC_FILES="src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c"
          for f in $SRC_FILES; do
            clang-tidy "$f" -p build/tidy-3 --warnings-as-errors='*'
            clang-tidy "$f" -p build/tidy-4 --warnings-as-errors='*'
          done

      - name: Run cppcheck
        run: |
          set -euo pipefail
          cppcheck --std=c11 --error-exitcode=1 --inline-suppr \
            --enable=warning,style,performance,portability \
            -DBOARD_SIZE=3 -I src src
          cppcheck --std=c11 --error-exitcode=1 --inline-suppr \
            --enable=warning,style,performance,portability \
            -DBOARD_SIZE=4 -I src src

  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build
        run: |
          set -euo pipefail
          make CC=${{ matrix.compiler }} BOARD_SIZE=${{ matrix.board_size }}

      - name: Run tests
        run: |
          set -euo pipefail
          make test CC=${{ matrix.compiler }} BOARD_SIZE=${{ matrix.board_size }}

      - name: Self-play verification
        run: |
          set -euo pipefail
          echo "Running self-play verification for perfect play..."
          OUTPUT=$(./ttt -s 1000000)
          echo "$OUTPUT"

          # Extract win/tie counts from output
          X_WINS=$(echo "$OUTPUT" | grep "X wins:" | awk '{print $3}')
          O_WINS=$(echo "$OUTPUT" | grep "O wins:" | awk '{print $3}')
          TIES=$(echo "$OUTPUT" | grep "Ties:" | awk '{print $2}')

          echo ""
          echo "=== Perfect Play Verification ==="
          echo "X wins: $X_WINS (expected: 0)"
          echo "O wins: $O_WINS (expected: 0)"
          echo "Ties: $TIES (expected: 1000000)"

          # Verify perfect play (all ties, no wins)
          if [ "$X_WINS" != "0" ]; then
            echo "FAILED: X should never win with perfect play (got $X_WINS wins)"
            exit 1
          fi

          if [ "$O_WINS" != "0" ]; then
            echo "FAILED: O should never win with perfect play (got $O_WINS wins)"
            exit 1
          fi

          if [ "$TIES" != "1000000" ]; then
            echo "FAILED: All games should be ties with perfect play (got $TIES ties)"
            exit 1
          fi

          echo "PASSED: Perfect play verified (100% ties)"

      - name: Self-play verification (TT disabled, 3x3 only)
        if: matrix.board_size == 3
        run: |
          set -euo pipefail
          echo "Running self-play verification with TT disabled..."
          OUTPUT=$(./ttt --tt-size 0 -s 100000)
          echo "$OUTPUT"

          # Extract win/tie counts from output
          X_WINS=$(echo "$OUTPUT" | grep "X wins:" | awk '{print $3}')
          O_WINS=$(echo "$OUTPUT" | grep "O wins:" | awk '{print $3}')
          TIES=$(echo "$OUTPUT" | grep "Ties:" | awk '{print $2}')

          echo ""
          echo "=== TT Disabled Verification ==="
          echo "X wins: $X_WINS (expected: 0)"
          echo "O wins: $O_WINS (expected: 0)"
          echo "Ties: $TIES (expected: 100000)"

          # Verify perfect play without TT (all ties, no wins)
          if [ "$X_WINS" != "0" ]; then
            echo "FAILED: X should never win with perfect play (got $X_WINS wins)"
            exit 1
          fi

          if [ "$O_WINS" != "0" ]; then
            echo "FAILED: O should never win with perfect play (got $O_WINS wins)"
            exit 1
          fi

          if [ "$TIES" != "100000" ]; then
            echo "FAILED: All games should be ties with perfect play (got $TIES ties)"
            exit 1
          fi

          echo "PASSED: Perfect play verified without TT (100% ties)"

  test-cmake:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        board_size: [3, 4]
        native_opt: [ON, OFF]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          set -euo pipefail
          cmake -B build -DBOARD_SIZE=${{ matrix.board_size }} -DCMAKE_BUILD_TYPE=Release -DENABLE_NATIVE_OPTIMIZATIONS=${{ matrix.native_opt }}

      - name: Build
        run: |
          set -euo pipefail
          cmake --build build --config Release

      - name: Run tests
        run: |
          set -euo pipefail
          ctest --test-dir build --build-config Release --output-on-failure

      - name: Self-play verification
        run: |
          set -euo pipefail
          echo "Running self-play verification for perfect play..."
          OUTPUT=$(./build/ttt -s 1000000)
          echo "$OUTPUT"

          # Extract win/tie counts from output
          X_WINS=$(echo "$OUTPUT" | grep "X wins:" | awk '{print $3}')
          O_WINS=$(echo "$OUTPUT" | grep "O wins:" | awk '{print $3}')
          TIES=$(echo "$OUTPUT" | grep "Ties:" | awk '{print $2}')

          echo ""
          echo "=== Perfect Play Verification ==="
          echo "X wins: $X_WINS (expected: 0)"
          echo "O wins: $O_WINS (expected: 0)"
          echo "Ties: $TIES (expected: 1000000)"

          # Verify perfect play (all ties, no wins)
          if [ "$X_WINS" != "0" ]; then
            echo "FAILED: X should never win with perfect play (got $X_WINS wins)"
            exit 1
          fi

          if [ "$O_WINS" != "0" ]; then
            echo "FAILED: O should never win with perfect play (got $O_WINS wins)"
            exit 1
          fi

          if [ "$TIES" != "1000000" ]; then
            echo "FAILED: All games should be ties with perfect play (got $TIES ties)"
            exit 1
          fi

          echo "PASSED: Perfect play verified (100% ties)"

      - name: Self-play verification (TT disabled, 3x3 only)
        if: matrix.board_size == 3
        run: |
          set -euo pipefail
          echo "Running self-play verification with TT disabled..."
          OUTPUT=$(./build/ttt --tt-size 0 -s 100000)
          echo "$OUTPUT"

          # Extract win/tie counts from output
          X_WINS=$(echo "$OUTPUT" | grep "X wins:" | awk '{print $3}')
          O_WINS=$(echo "$OUTPUT" | grep "O wins:" | awk '{print $3}')
          TIES=$(echo "$OUTPUT" | grep "Ties:" | awk '{print $2}')

          echo ""
          echo "=== TT Disabled Verification ==="
          echo "X wins: $X_WINS (expected: 0)"
          echo "O wins: $O_WINS (expected: 0)"
          echo "Ties: $TIES (expected: 100000)"

          # Verify perfect play without TT (all ties, no wins)
          if [ "$X_WINS" != "0" ]; then
            echo "FAILED: X should never win with perfect play (got $X_WINS wins)"
            exit 1
          fi

          if [ "$O_WINS" != "0" ]; then
            echo "FAILED: O should never win with perfect play (got $O_WINS wins)"
            exit 1
          fi

          if [ "$TIES" != "100000" ]; then
            echo "FAILED: All games should be ties with perfect play (got $TIES ties)"
            exit 1
          fi

          echo "PASSED: Perfect play verified without TT (100% ties)"

  test-windows:
    runs-on: windows-latest
    timeout-minutes: 30
    strategy:
      matrix:
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -B build -DBOARD_SIZE=${{ matrix.board_size }} -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Run tests
        run: ctest --test-dir build --build-config Release --output-on-failure

      - name: Self-play verification
        shell: pwsh
        run: |
          $output = & ./build/Release/ttt.exe -s 1000000
          $output | ForEach-Object { Write-Host $_ }

          $xWins = ($output | Select-String "X wins:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          $oWins = ($output | Select-String "O wins:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          $ties = ($output | Select-String "Ties:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })

          Write-Host ""
          Write-Host "=== Perfect Play Verification ==="
          Write-Host "X wins: $xWins (expected: 0)"
          Write-Host "O wins: $oWins (expected: 0)"
          Write-Host "Ties: $ties (expected: 1000000)"

          if ($xWins -ne "0") { Write-Host "FAILED: X wins"; exit 1 }
          if ($oWins -ne "0") { Write-Host "FAILED: O wins"; exit 1 }
          if ($ties -ne "1000000") { Write-Host "FAILED: Not all ties"; exit 1 }

          Write-Host "PASSED: Perfect play verified (100% ties)"

      - name: Self-play verification (TT disabled, 3x3 only)
        if: matrix.board_size == 3
        shell: pwsh
        run: |
          Write-Host "Running self-play verification with TT disabled..."
          $output = & ./build/Release/ttt.exe --tt-size 0 -s 100000
          $output | ForEach-Object { Write-Host $_ }

          $xWins = ($output | Select-String "X wins:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          $oWins = ($output | Select-String "O wins:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          $ties = ($output | Select-String "Ties:\s+(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value })

          Write-Host ""
          Write-Host "=== TT Disabled Verification ==="
          Write-Host "X wins: $xWins (expected: 0)"
          Write-Host "O wins: $oWins (expected: 0)"
          Write-Host "Ties: $ties (expected: 100000)"

          if ($xWins -ne "0") { Write-Host "FAILED: X wins"; exit 1 }
          if ($oWins -ne "0") { Write-Host "FAILED: O wins"; exit 1 }
          if ($ties -ne "100000") { Write-Host "FAILED: Not all ties"; exit 1 }

          Write-Host "PASSED: Perfect play verified without TT (100% ties)"

  strict-warnings:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build with strict warnings
        run: |
          set -euo pipefail
          COMMON="-Wall -Wextra -Wpedantic -Werror"
          COMMON="$COMMON -Wshadow -Wconversion -Wsign-conversion -Wformat=2 -Wundef"
          COMMON="$COMMON -Wdouble-promotion -Wcast-qual -Wnull-dereference"
          COMMON="$COMMON -Wvla -Wwrite-strings -Wformat-security -Wswitch-enum"
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            COMMON="$COMMON -Wlogical-op -Wduplicated-cond -Wduplicated-branches"
          fi

          # Prototype warnings apply to production code but not Unity test functions
          # (test functions are called via RUN_TEST() macro, no headers exist for them)
          APP_STRICT="$COMMON -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition"
          TEST_STRICT="$COMMON"

          APP_SRC="src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c"
          TEST_SRC="test/test_runner.c test/test_bitboard.c test/test_minimax.c test/test_zobrist.c test/test_transposition_table.c test/test_game_scenarios.c test/test_edge_cases.c test/test_correctness.c test/unity/unity.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c"

          ${{ matrix.compiler }} -std=c11 $APP_STRICT -DBOARD_SIZE=${{ matrix.board_size }} \
            $APP_SRC \
            -o /dev/null -lm

          ${{ matrix.compiler }} -std=c11 $TEST_STRICT -DBOARD_SIZE=${{ matrix.board_size }} -I test/unity \
            $TEST_SRC \
            -o /dev/null -lm

  sanitize:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      matrix:
        compiler: [gcc, clang]
        board_size: [3, 4]
    env:
      ASAN_OPTIONS: detect_leaks=1:strict_string_checks=1:check_initialization_order=1
      UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and run tests under ASan+UBSan
        run: |
          set -euo pipefail
          ${{ matrix.compiler }} -std=c11 -O1 -Wall -Wextra -Werror -g -fno-omit-frame-pointer \
            -fsanitize=address,undefined,float-divide-by-zero,float-cast-overflow,pointer-compare,pointer-subtract \
            -DBOARD_SIZE=${{ matrix.board_size }} -I test/unity \
            test/test_runner.c test/test_bitboard.c test/test_minimax.c test/test_zobrist.c \
            test/test_transposition_table.c test/test_game_scenarios.c test/test_edge_cases.c \
            test/test_correctness.c test/unity/unity.c \
            src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o test_runner_san -lm
          ./test_runner_san

      - name: Run self-play under ASan+UBSan
        run: |
          set -euo pipefail
          ${{ matrix.compiler }} -std=c11 -O1 -Wall -Wextra -Werror -g -fno-omit-frame-pointer \
            -fsanitize=address,undefined,float-divide-by-zero,float-cast-overflow,pointer-compare,pointer-subtract \
            -DBOARD_SIZE=${{ matrix.board_size }} \
            src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o ttt_san -lm
          ./ttt_san -s 1000 -q

  valgrind:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        compiler: [gcc, clang]
        board_size: [3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install valgrind
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y valgrind

      - name: Build test runner for valgrind
        run: |
          set -euo pipefail
          ${{ matrix.compiler }} -std=c11 -O1 -g -Wall -Wextra -Werror \
            -DBOARD_SIZE=${{ matrix.board_size }} -I test/unity \
            test/test_runner.c test/test_bitboard.c test/test_minimax.c test/test_zobrist.c \
            test/test_transposition_table.c test/test_game_scenarios.c test/test_edge_cases.c \
            test/test_correctness.c test/unity/unity.c \
            src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o test_runner_valgrind -lm

      - name: Run tests under valgrind
        run: |
          set -euo pipefail
          valgrind --leak-check=full --show-leak-kinds=all \
            --errors-for-leak-kinds=all --error-exitcode=1 \
            ./test_runner_valgrind

      - name: Run self-play under valgrind
        run: |
          set -euo pipefail
          ${{ matrix.compiler }} -std=c11 -O1 -g -Wall -Wextra -Werror \
            -DBOARD_SIZE=${{ matrix.board_size }} \
            src/main.c src/TicTacToe/tic_tac_toe.c src/MiniMax/mini_max.c src/MiniMax/transposition.c \
            -o ttt_valgrind -lm
          valgrind --leak-check=full --show-leak-kinds=all \
            --errors-for-leak-kinds=all --error-exitcode=1 \
            ./ttt_valgrind -s 1000 -q
